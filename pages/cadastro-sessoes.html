<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Sess√µes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css" />

</head>
<body>
  <header class="topbar">
    <nav class="nav">
      <a href="../index.html" class="brand">üé¨ Cinema</a>
      <a href="./cadastro-filmes.html">Cadastro de Filmes</a>
      <a href="./cadastro-salas.html">Cadastro de Salas</a>
      <a href="./cadastro-sessoes.html">Cadastro de Sess√µes</a>
      <a href="./venda-ingressos.html">Venda de Ingressos</a>
      <a href="./sessoes.html">Sess√µes Dispon√≠veis</a>
    </nav>
  </header>

  <main class="container py-4">
    <h1 class="mb-3">Cadastro de Sess√µes</h1>
    <div id="status" class="mb-3"></div>

    <form id="form-sessao" class="card card-body mb-4">
      <div class="grid">
        <div>
          <label class="form-label" for="filme">Filme</label>
          <select class="form-select" id="filme" name="filme" required>
            <option value="">Selecione</option>
          </select>
        </div>
        <div>
          <label class="form-label" for="sala">Sala</label>
          <select class="form-select" id="sala" name="sala" required>
            <option value="">Selecione</option>
          </select>
        </div>
        <div>
          <label class="form-label" for="datahora">Data e Hora</label>
          <input class="form-control" id="datahora" name="datahora" type="datetime-local" required />
        </div>
        <div>
          <label class="form-label" for="preco">Pre√ßo (R$)</label>
          <input class="form-control" id="preco" name="preco" type="number" min="0" step="0.01" required />
        </div>
        <div>
          <label class="form-label" for="idioma">Idioma</label>
          <select class="form-select" id="idioma" name="idioma" required>
            <option value="">Selecione</option>
            <option>Dublado</option>
            <option>Legendado</option>
          </select>
        </div>
        <div>
          <label class="form-label" for="formato">Formato</label>
          <select class="form-select" id="formato" name="formato" required>
            <option value="">Selecione</option>
            <option>2D</option>
            <option>3D</option>
          </select>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Salvar Sess√£o</button>
      </div>
    </form>

    <h2 class="h4 mb-3">Sess√µes cadastradas</h2>
    <table class="table table-dark table-striped align-middle" id="lista-sessoes">
      <thead>
        <tr>
          <th>Filme</th>
          <th>Sala</th>
          <th>Data e Hora</th>
          <th>Pre√ßo</th>
          <th>Idioma</th>
          <th>Formato</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/app.js"></script>
  <script>
    const { STORAGE_KEYS, uid, load, addItem, setStatus, formatDateTime } = window.Cinema;

    function populateSelects(){
      const filmes = load(STORAGE_KEYS.filmes);
      const salas = load(STORAGE_KEYS.salas);
      const selFilme = document.getElementById('filme');
      const selSala = document.getElementById('sala');
      selFilme.innerHTML = '<option value="">Selecione</option>' + filmes.map(f => `<option value="${f.id}">${f.titulo}</option>`).join('');
      selSala.innerHTML = '<option value="">Selecione</option>' + salas.map(s => `<option value="${s.id}">${s.nome} (${s.tipo}, cap. ${s.capacidade})</option>`).join('');
    }

    function render(){
      const tbody = document.querySelector('#lista-sessoes tbody');
      tbody.innerHTML = '';
      const filmes = load(STORAGE_KEYS.filmes);
      const salas = load(STORAGE_KEYS.salas);
      const sessoes = load(STORAGE_KEYS.sessoes);
      for(const se of sessoes){
        const filme = filmes.find(f => f.id === se.filmeId);
        const sala = salas.find(s => s.id === se.salaId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${filme ? filme.titulo : '‚Äî'}</td>
          <td>${sala ? sala.nome : '‚Äî'}</td>
          <td>${formatDateTime(se.datahora)}</td>
          <td>R$ ${Number(se.preco).toFixed(2)}</td>
          <td><span class="badge">${se.idioma}</span></td>
          <td><span class="badge">${se.formato}</span></td>
        `;
        tbody.appendChild(tr);
      }
    }

    document.getElementById('form-sessao').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const data = {
        id: uid(),
        filmeId: form.filme.value,
        salaId: form.sala.value,
        datahora: form.datahora.value,
        preco: Number(form.preco.value),
        idioma: form.idioma.value,
        formato: form.formato.value
      };
      if(!data.filmeId || !data.salaId || !data.datahora){
        setStatus(document.getElementById('status'), 'err', 'Preencha todos os campos.');
        return;
      }
      addItem(STORAGE_KEYS.sessoes, data);
      setStatus(document.getElementById('status'), 'ok', 'Sess√£o salva com sucesso!');
      form.reset();
      render();
    });

    document.addEventListener('DOMContentLoaded', () => { populateSelects(); render(); });
  </script>
</body>
</html>