<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Venda de Ingressos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css" />
</head>
<body>
  <header class="topbar">
    <nav class="nav">
      <a href="../index.html" class="brand">üé¨ Cinema</a>
      <a href="./cadastro-filmes.html">Cadastro de Filmes</a>
      <a href="./cadastro-salas.html">Cadastro de Salas</a>
      <a href="./cadastro-sessoes.html">Cadastro de Sess√µes</a>
      <a href="./venda-ingressos.html">Venda de Ingressos</a>
      <a href="./sessoes.html">Sess√µes Dispon√≠veis</a>
    </nav>
  </header>

  <main class="container py-4">
    <h1 class="mb-3">Venda de Ingressos</h1>
    <div id="status" class="mb-3"></div>

    <form id="form-ingresso" class="card card-body mb-4">
      <div class="grid">
        <div>
          <label class="form-label" for="sessao">Sess√£o</label>
          <select class="form-select" id="sessao" name="sessao" required>
            <option value="">Selecione</option>
          </select>
          <div class="form-text" id="sessao-info"></div>
        </div>
        <div>
          <label class="form-label" for="cliente">Nome do Cliente</label>
          <input class="form-control" id="cliente" name="cliente" required />
        </div>
        <div>
          <label class="form-label" for="cpf">CPF</label>
          <input class="form-control" id="cpf" name="cpf" required />
        </div>
        <div>
          <label class="form-label" for="assento">Assento (ex: A10)</label>
          <input class="form-control" id="assento" name="assento" required />
        </div>
        <div>
          <label class="form-label" for="pagamento">Tipo de Pagamento</label>
          <select class="form-select" id="pagamento" name="pagamento" required>
            <option value="">Selecione</option>
            <option>Cart√£o</option>
            <option>Pix</option>
            <option>Dinheiro</option>
          </select>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Confirmar Venda</button>
      </div>
    </form>

    <h2 class="h4 mb-3">Ingressos vendidos</h2>
    <table class="table table-dark table-striped align-middle" id="lista-ingressos">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>CPF</th>
          <th>Assento</th>
          <th>Sess√£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/app.js"></script>
  <script>
    const { STORAGE_KEYS, uid, load, addItem, setStatus, getQuery, findById, formatDateTime } = window.Cinema;

    function populateSessoes(){
      const filmes = load(STORAGE_KEYS.filmes);
      const salas = load(STORAGE_KEYS.salas);
      const sessoes = load(STORAGE_KEYS.sessoes);
      const sel = document.getElementById('sessao');
      sel.innerHTML = '<option value="">Selecione</option>' + sessoes.map(s => {
        const f = filmes.find(x => x.id === s.filmeId);
        const sa = salas.find(x => x.id === s.salaId);
        return `<option value="${s.id}">${f ? f.titulo : '‚Äî'} - ${sa ? sa.nome : '‚Äî'} - ${formatDateTime(s.datahora)} (R$ ${Number(s.preco).toFixed(2)})</option>`
      }).join('');
    }

    function updateSessaoInfo(){
      const id = document.getElementById('sessao').value;
      const filmes = load(STORAGE_KEYS.filmes);
      const salas = load(STORAGE_KEYS.salas);
      const sessoes = load(STORAGE_KEYS.sessoes);
      const ingressos = load(STORAGE_KEYS.ingressos);
      const s = sessoes.find(x => x.id === id);
      const sala = s ? salas.find(sa => sa.id === s.salaId) : null;
      const vendidos = ingressos.filter(i => i.sessaoId === id).length;
      const texto = s && sala ? `Capacidade: ${sala.capacidade} | Vendidos: ${vendidos} | Restantes: ${Math.max(0, sala.capacidade - vendidos)}` : '';
      document.getElementById('sessao-info').textContent = texto;
    }

    function render(){
      const tbody = document.querySelector('#lista-ingressos tbody');
      tbody.innerHTML = '';
      const filmes = load(STORAGE_KEYS.filmes);
      const salas = load(STORAGE_KEYS.salas);
      const sessoes = load(STORAGE_KEYS.sessoes);
      const ingressos = load(STORAGE_KEYS.ingressos);
      for(const ing of ingressos){
        const s = findById(sessoes, ing.sessaoId);
        const f = s ? findById(filmes, s.filmeId) : null;
        const sa = s ? findById(salas, s.salaId) : null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ing.cliente}</td>
          <td>${ing.cpf}</td>
          <td>${ing.assento}</td>
          <td>${f ? f.titulo : '‚Äî'} / ${sa ? sa.nome : '‚Äî'} / ${s ? formatDateTime(s.datahora) : ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    document.getElementById('sessao').addEventListener('change', updateSessaoInfo);

    document.getElementById('form-ingresso').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const data = {
        id: uid(),
        sessaoId: form.sessao.value,
        cliente: form.cliente.value.trim(),
        cpf: form.cpf.value.trim(),
        assento: form.assento.value.trim().toUpperCase(),
        pagamento: form.pagamento.value
      };
      if(!data.sessaoId || !data.cliente || !data.cpf || !data.assento || !data.pagamento){
        setStatus(document.getElementById('status'), 'err', 'Preencha todos os campos.');
        return;
      }
      // Valida capacidade e assento duplicado
      const sessoes = load(STORAGE_KEYS.sessoes);
      const salas = load(STORAGE_KEYS.salas);
      const ingressos = load(STORAGE_KEYS.ingressos);
      const sessao = findById(sessoes, data.sessaoId);
      const sala = sessao ? findById(salas, sessao.salaId) : null;
      const vendidos = ingressos.filter(i => i.sessaoId === data.sessaoId);
      if(sala && vendidos.length >= sala.capacidade){
        setStatus(document.getElementById('status'), 'err', 'Capacidade esgotada para esta sess√£o.');
        return;
      }
      const assentoOcupado = vendidos.some(i => i.assento === data.assento);
      if(assentoOcupado){
        setStatus(document.getElementById('status'), 'err', 'Assento j√° vendido para esta sess√£o.');
        return;
      }

      addItem(STORAGE_KEYS.ingressos, data);
      setStatus(document.getElementById('status'), 'ok', 'Venda confirmada!');
      form.reset();
      populateSessoes();
      updateSessaoInfo();
      render();
    });

    document.addEventListener('DOMContentLoaded', () => {
      populateSessoes();
      // Pr√©-sele√ß√£o via URL (sessaoId=...)
      const q = getQuery();
      if(q.sessaoId){
        const sel = document.getElementById('sessao');
        sel.value = q.sessaoId;
      }
      updateSessaoInfo();
      render();
    });
  </script>
</body>
</html>